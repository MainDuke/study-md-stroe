```

```

참조 : https://nodered.org/docs/security

주제 : node-red 보안요소

경로 : 라즈베리파이
home/pi/.node-red/setting.js

해당 경로에 있는 세팅 파일에서
필요한 부분을 만들어주면 됩니다.

```javascript
adminAuth: {
type: "credentials",
users: [{
username: "admin",
password: "$2a$08$zZWtXTja0fB1pzD4sHCMyOCMYz2Z6dNbM6tl8sJogENOMcxWV9DN.",
permissions: "*"
}]
}
```

이 users속성은 사용자 개체의 배열입니다. 이렇게하면 각각 다른 권한을 가질 수있는 여러 사용자를 정의 할 수 있습니다.

```javascript
users: [
  {
    username: "admin",
    password: "$2a$08$zZWtXTja0fB1pzD4sHCMyOCMYz2Z6dNbM6tl8sJogENOMcxWV9DN.",
    permissions: "*"
  }
];
```

```
permissions: "*" --> 모든 권한
password. 암호는 bcrypt 알고리즘을 사용하여 안전하게 해시됩니다.
```

---

## 비밀번호 해쉬화

참조 : https://nodered.org/docs/node-red-admin

1. 설치
   sudo npm install -g node-red-admin

2. 호출
   sudo node-red-admin hash-pw
3. 해쉬 생성 (pWD) 입력
   ,

curl http://121.160.17.110:41980/auth/token --data 'client_id=node-red-admin&grant_type=password&scope=\*&username=admin&password=rnd12345'

{"access_token":"XNEzQ4EwxPfnotxT3M8OZXBryGoXOHFC1YJfenaDh0qtdbOcx2DapkxJKCC8d5ZlSUBRpTlI08sGM7DneSCuvo7xZ8DhKewSZx1rDBLxY6yLAwGwT7Mbz1BIB7xv5guf","expires_in":604800,"token_type":"Bearer"}

curl -H "Authorization: Bearer XNEzQ4EwxPfnotxT3M8OZXBryGoXOHFC1YJfenaDh0qtdbOcx2DapkxJKCC8d5ZlSUBRpTlI08sGM7DneSCuvo7xZ8DhKewSZx1rDBLxY6yLAwGwT7Mbz1BIB7xv5guf" http://121.160.17.110:41980/settings

```json
{
  "httpNodeRoot": "/",
  "version": "0.20.5",
  "user": { "username": "admin", "permissions": "*" },
  "context": { "default": "memory", "stores": ["memory"] },
  "flowEncryptionType": "system",
  "tlsConfigDisableLocalFiles": false,
  "editorTheme": {
    "menu": {
      "menu-item-help": {
        "label": "Node-RED Pi Website",
        "url": "http://nodered.org/docs/hardware/raspberrypi.html"
      }
    },
    "projects": { "enabled": false }
  }
}
```

```
curl -H "Authorization: Bearer XNEzQ4EwxPfnotxT3M8OZXBryGoXOHFC1YJfenaDh0qtdbOcx2DapkxJKCC8d5ZlSUBRpTlI08sGM7DneSCuvo7xZ8DhKewSZx1rDBLxY6yLAwGwT7Mbz1BIB7xv5guf" http://121.160.17.110:41980/flows
```

```json
curl -H "Authorization: Bearer XNEzQ4EwxPfnotxT3M8OZXBryGoXOHFC1YJfenaDh0qtdbOcx2DapkxJKCC8d5ZlSUBRpTlI08sGM7DneSCuvo7xZ8DhKewSZx1rDBLxY6yLAwGwT7Mbz1BIB7xv5guf" http://121.160.17.110:41980/flows

[
  {"id":"ea60bfd7.dee7","type":"tab","label":"(개발완)getMAC","disabled":false,"info":""},{"id":"f6c2454e.b1ec78","type":"tab","label":"컨트롤러","disabled":false,"info":""},{"id":"dd937178.fef3e","type":"tab","label":"온습도센서","disabled":false,"info":""},{"id":"86722306.5dedf","type":"tab","label":"플로우 2","disabled":false,"info":""},{"id":"937423a3.0cf86","type":"tab","label":"MQTT-Controller","disabled":false,"info":""},{"id":"59d70421.77908c","type":"ui_base","theme":{"name":"theme-dark","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#097479","value":"#097479","edited":false},"page-titlebar-backgroundColor":{"value":"#097479","edited":false},"page-backgroundColor":{"value":"#111111","edited":false},"page-sidebar-backgroundColor":{"value":"#000000","edited":false},"group-textColor":{"value":"#0eb8c0","edited":false},"group-borderColor":{"value":"#555555","edited":false},"group-backgroundColor":{"value":"#333333","edited":false},"widget-textColor":{"value":"#eeeeee","edited":false},"widget-backgroundColor":{"value":"#097479","edited":false},"widget-borderColor":{"value":"#333333","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"30d38039.04ddc","type":"ui_tab","z":"","name":"온습도","icon":"dashboard","disabled":false,"hidden":false},{"id":"cacf50d9.b8cb6","type":"ui_group","z":"","name":"온습도(현재)","tab":"30d38039.04ddc","disp":true,"width":"6","collapse":false},{"id":"32298fb2.63e84","type":"ui_group","z":"","name":"온습도(차트)","tab":"30d38039.04ddc","order":2,"disp":true,"width":"6","collapse":false},{"id":"7bb932eb.d2ba5c","type":"ui_group","z":"","name":"미세먼지(현재)","tab":"30d38039.04ddc","order":3,"disp":true,"width":"6","collapse":false},{"id":"8b89ed4c.4e48a","type":"ui_group","z":"","name":"미 세먼지(차트)","tab":"30d38039.04ddc","order":4,"disp":true,"width":"6","collapse":false},{"id":"2bcc64f3.be443c","type":"mqtt-broker","z":"","name":"test-mqtt","broker":"121.160.17.68","port":"8883","tls":"cd61adf2.b7d5b","clientid":"","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"cd61adf2.b7d5b","type":"tls-config","z":"","name":"","cert":"","key":"","ca":"","certname":"server.crt","keyname":"","caname":"","servername":"","verifyservercert":true},{"id":"65ccab92.ae5754","type":"rpi-dht22","z":"dd937178.fef3e","name":"","topic":"rpi-dht22","dht":22,"pintype":"0","pin":4,"x":560,"y":280,"wires":[["14af86e.0c88d79","8011b41a.494958","b039878.a8b2678","8a23cf80.d3ea5","a1ce2f74.f9486","5d23e93c.3b4bb8"]]},{"id":"81781a24.c62c18","type":"inject","z":"dd937178.fef3e","name":"","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":false,"onceDelay":0.1,"x":410,"y":220,"wires":[["65ccab92.ae5754"]]},{"id":"14af86e.0c88d79","type":"ui_gauge","z":"dd937178.fef3e","name":"","group":"cacf50d9.b8cb6","order":1,"width":0,"height":0,"gtype":"gage","title":"온도","label":"섭씨 Celsius","format":"{{msg.payload}}","min":"-40","max":"80","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":850,"y":220,"wires":[]},{"id":"8011b41a.494958","type":"ui_gauge","z":"dd937178.fef3e","name":"","group":"cacf50d9.b8cb6","order":2,"width":0,"height":0,"gtype":"gage","title":"습도","label":"% (상대습도)","format":"{{msg.humidity}}","min":0,"max":"100","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":850,"y":280,"wires":[]},{"id":"a763804c.c9b5e","type":"ui_chart","z":"dd937178.fef3e","name":"","group":"32298fb2.63e84","order":1,"width":0,"height":0,"label":"온도값(차트)","chartType":"line","legend":"true","xformat":"dd HH:mm","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#80ffff","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":970,"y":340,"wires":[[]]},{"id":"f12447ac.bb9c88","type":"ui_chart","z":"dd937178.fef3e","name":"","group":"32298fb2.63e84","order":2,"width":0,"height":0,"label":"습도값(차트)","chartType":"line","legend":"true","xformat":"dd HH:mm","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#0000ff","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":970,"y":400,"wires":[[]]},{"id":"94579f31.e0f4f","type":"ui_gauge","z":"dd937178.fef3e","name":"","group":"7bb932eb.d2ba5c","order":1,"width":0,"height":0,"gtype":"gage","title":"PM2.5","label":"μ g/m³","format":"{{msg.payload}}","min":0,"max":"999","colors":["#00b500","#e6e600","#ca3838"],"seg1":"40","seg2":"80","x":1030,"y":620,"wires":[]},{"id":"474e4667.6f9298","type":"ui_gauge","z":"dd937178.fef3e","name":"","group":"7bb932eb.d2ba5c","order":2,"width":0,"height":0,"gtype":"gage","title":"PM10","label":"μ g/m³","format":"{{msg.payload}}","min":0,"max":"999","colors":["#00b500","#e6e600","#ca3838"],"seg1":"40","seg2":"80","x":1030,"y":660,"wires":[]},{"id":"9658dc8a.ec7fa","type":"ui_chart","z":"dd937178.fef3e","name":"","group":"8b89ed4c.4e48a","order":1,"width":0,"height":0,"label":"PM2.5 (차트)","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#20d200","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1050,"y":720,"wires":[[]]},{"id":"78d1a554.15dc7c","type":"ui_chart","z":"dd937178.fef3e","name":"","group":"8b89ed4c.4e48a","order":2,"width":0,"height":0,"label":"PM10 (차트)","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"","ymax":"","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"3600","cutout":0,"useOneColor":false,"colors":["#0000ff","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"outputs":1,"x":1050,"y":780,"wires":[[]]},{"id":"b039878.a8b2678","type":"function","z":"dd937178.fef3e","name":"온도-추출-전달","func":"\nvar test={};\n\ntest.topic=\"온도\";\ntest.payload=msg.payload;\n\nreturn test;","outputs":1,"noerr":0,"x":760,"y":340,"wires":[["a763804c.c9b5e"]]},{"id":"8a23cf80.d3ea5","type":"function","z":"dd937178.fef3e","name":"습도-추출-전달","func":"\nvar test={};\n\ntest.topic=\"습도\";\ntest.payload=msg.humidity;\n\nreturn test;","outputs":1,"noerr":0,"x":760,"y":400,"wires":[["f12447ac.bb9c88"]]},{"id":"a1ce2f74.f9486","type":"function","z":"dd937178.fef3e","name":"습도경고","func":"if(msg.humidity > 50){\n\nvar test={};\n\ntest.payload=\"습도 경고!\"\n\nreturn test;\n}else{\n   return null;\n}\n","outputs":1,"noerr":0,"x":720,"y":520,"wires":[["6a54d420.bc03ac"]]},{"id":"6a54d420.bc03ac","type":"debug","z":"dd937178.fef3e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":890,"y":520,"wires":[]},{"id":"c0db5b53.3b05f8","type":"comment","z":"dd937178.fef3e","name":"MQTT 분기용 Function","info":"","x":760,"y":480,"wires":[]},{"id":"edb1d6bc.2e3a88","type":"inject","z":"dd937178.fef3e","name":"","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":true,"onceDelay":0.1,"x":370,"y":620,"wires":[["4f63939b.40ed2c"]]},{"id":"4f63939b.40ed2c","type":"pythonshell in","z":"dd937178.fef3e","name":"","pyfile":"/home/pi/dev-py/PMS7003-master/PMS7003-master/dust_chk.py","virtualenv":"","continuous":false,"stdInData":false,"x":580,"y":620,"wires":[["f33b96b9.c505e8"]]},{"id":"f33b96b9.c505e8","type":"function","z":"dd937178.fef3e","name":"미세-추출-전달","func":"var test={}\nvar temp=msg.payload.split(\"\\n\");\n\ntest.pm25={'payload':temp[3]};\ntest.pm10={'payload':temp[5]};\n\nreturn [test.pm25, test.pm10];","outputs":2,"noerr":0,"x":800,"y":620,"wires":[["94579f31.e0f4f","9658dc8a.ec7fa"],["474e4667.6f9298","78d1a554.15dc7c"]]},{"id":"5d23e93c.3b4bb8","type":"mqtt out","z":"dd937178.fef3e","name":"","topic":"/hello","qos":"","retain":"","broker":"2bcc64f3.be443c","x":1070,"y":220,"wires":[]},{"id":"86f6e368.5137f","type":"debug","z":"dd937178.fef3e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":950,"y":160,"wires":[]},{"id":"14d45d0.12c6da3","type":"mqtt in","z":"937423a3.0cf86","name":"","topic":"/rasp-set-config","qos":"2","datatype":"auto","broker":"2bcc64f3.be443c","x":120,"y":120,"wires":[[]]},{"id":"44c1e949.0c4418","type":"debug","z":"937423a3.0cf86","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":370,"y":40,"wires":[]},{"id":"84d0d247.57f95","type":"function","z":"937423a3.0cf86","name":"미세-추출-전달","func":"var test={}\n\nif(global.get ( \"power\")){\n    test.payload=\"on\"\n}\nelse{\n    test.payload=\"off\"\n}\n\n\nreturn test;","outputs":1,"noerr":0,"x":560,"y":580,"wires":[[]]},{"id":"8ac2856c.5493c8","type":"comment","z":"937423a3.0cf86","name":"PUB-명령어","info":"mosquitto_pub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /rasp-set-config -m \"???\"\nmosquitto_pub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /rasp-set-config -m \"{\\\"result\\\":true, \\\"count\\\":1}\"\n\n\nvar json = '{\"result\":true, \"count\":42}';\nobj = JSON.parse(json);\n\nconsole.log(obj.count);\n// expected output: 42\n\nconsole.log(obj.result);\n// expected output: true\n","x":110,"y":200,"wires":[]},{"id":"557a62cd.57f75c","type":"function","z":"937423a3.0cf86","name":"제이슨 파싱","func":"var json = '{\"result\":5, \"count\":42}';\n\nobj = JSON.parse(json);\n\nmsg={}\nmsg.payload=obj.result;\n\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":520,"wires":[[]]},{"id":"606051b6.3a677","type":"debug","z":"937423a3.0cf86","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":570,"y":160,"wires":[]},{"id":"984e0912.a95458","type":"inject","z":"937423a3.0cf86","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":350,"y":580,"wires":[["84d0d247.57f95"]]},{"id":"2b681bf9.41fd64","type":"comment","z":"937423a3.0cf86","name":"JSON-PARSE","info":"var json = '{\"result\":true, \"count\":42}';\nobj = JSON.parse(json);\n\nmsg={}\nmsg.payload=obj.result;\n\nreturn msg;","x":110,"y":240,"wires":[]},{"id":"d1f1de36.9d6bc","type":"config","z":"937423a3.0cf86","name":"ON","properties":[{"p":"test1","pt":"global","to":"{\"test\":100}","tot":"json"},{"p":"power","pt":"global","to":"true","tot":"bool"},{"p":"set_value","pt":"global","to":"5","tot":"num"}],"active":true,"x":590,"y":80,"wires":[]},{"id":"4a46a174.9ce82","type":"inject","z":"937423a3.0cf86","name":"test1","topic":"","payload":"false","payloadType":"bool","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":530,"y":520,"wires":[["557a62cd.57f75c"]]},{"id":"222081f7.b21e2e","type":"debug","z":"937423a3.0cf86","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":580,"wires":[]},{"id":"f45a3f4e.15f4c","type":"function","z":"937423a3.0cf86","name":"파싱-컨트롤러","func":"var json = JSON.parse(msg.payload);\n\nmsg={}\n\nif(json.result == true){\nmsg.v1=json.result;\nreturn msg;\n    \n}\n\nreturn [msg.v1, msg.v2];","outputs":2,"noerr":0,"x":340,"y":120,"wires":[["606051b6.3a677","d1f1de36.9d6bc"],["3457cf07.4a511","606051b6.3a677"]]},{"id":"3457cf07.4a511","type":"config","z":"937423a3.0cf86","name":"OFF","properties":[{"p":"test1","pt":"global","to":"{\"test\":200}","tot":"json"},{"p":"power","pt":"global","to":"false","tot":"bool"},{"p":"test_time","pt":"global","to":"","tot":"date"},{"p":"set_value","pt":"global","to":"15","tot":"num"}],"active":true,"x":590,"y":120,"wires":[]},{"id":"d3de7370.595cf","type":"function","z":"937423a3.0cf86","name":"미세-추출-전달","func":"var test={}\n\nif(global.get ( \"power\")){\n    test.payload=\"on\"\n}\nelse{\n    test.payload=\"off\"\n}\n\n\nreturn test;","outputs":1,"noerr":0,"x":540,"y":660,"wires":[[]]},{"id":"2ef7ceb4.c6cb22","type":"inject","z":"937423a3.0cf86","name":"","topic":"","payload":"test_time","payloadType":"global","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":340,"y":660,"wires":[["d3de7370.595cf"]]},{"id":"4f08d164.f31ba","type":"debug","z":"937423a3.0cf86","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":710,"y":660,"wires":[]},{"id":"b75528a.f3de4d8","type":"configurable interval","z":"937423a3.0cf86","name":"configurable interval","interval":"15","onstart":false,"do_enable":true,"msg":"ping","showstatus":true,"unit":"seconds","statusformat":"YYYY-MM-D HH:mm:ss","x":600,"y":740,"wires":[[]]},{"id":"82c5f04d.8cd76","type":"inject","z":"937423a3.0cf86","name":"","topic":"","payload":"","payloadType":"date","repeat":"5","crontab":"","once":true,"onceDelay":0.1,"x":150,"y":740,"wires":[["3a8bb62c.b1402a"]]},{"id":"97a5c3a5.cde64","type":"function","z":"937423a3.0cf86","name":"미세-추출-전달","func":"var test={}\n\ntest.interval=global.get (\"set_value\");\n\nreturn test;","outputs":1,"noerr":0,"x":240,"y":840,"wires":[[]]},{"id":"d7693dc6.3cab1","type":"debug","z":"937423a3.0cf86","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":470,"y":840,"wires":[]},{"id":"3044af19.3c313","type":"debug","z":"937423a3.0cf86","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":890,"y":780,"wires":[]},{"id":"3bae730b.69212c","type":"function","z":"937423a3.0cf86","name":"미세-추출-전달","func":"var test={}\n\nif(global.get ( \"power\")){\n    test.payload=\"on\"\n}\nelse{\n    test.payload=\"off\"\n}\n\n\nreturn test;","outputs":1,"noerr":0,"x":780,"y":880,"wires":[["3044af19.3c313"]]},{"id":"54c2c6a0.f26fd8","type":"function","z":"86722306.5dedf","name":"ModifyOutput","func":"\nvar mssInitial = flow.get(\"dbgtimer\");\nvar mss = Date.now() / 1000.0;\n\nmsg.payload = mss - mssInitial;\n\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":420,"wires":[["5d76bb1e.177fd4"]]},{"id":"fdcbeec3.53836","type":"inject","z":"86722306.5dedf","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":130,"y":100,"wires":[["4d1e89c8.e2cb98"]]},{"id":"4d1e89c8.e2cb98","type":"function","z":"86722306.5dedf","name":"InitialSeconds","func":"msg.payload = msg.payload / 1000.0;\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":160,"wires":[["9ed2205c.6f6c3"]]},{"id":"9ed2205c.6f6c3","type":"change","z":"86722306.5dedf","name":"SetFlowInitial","rules":[{"t":"set","p":"dbgtimer","pt":"flow","to":"payload","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"enabled","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":400,"y":100,"wires":[["eac9bf6d.10099"]]},{"id":"5d76bb1e.177fd4","type":"debug","z":"86722306.5dedf","name":"FireTime","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":540,"wires":[]},{"id":"880ea897.cc9578","type":"change","z":"86722306.5dedf","name":"_18s","rules":[{"t":"set","p":"payload","pt":"msg","to":"interval","tot":"str"},{"t":"set","p":"interval_value","pt":"msg","to":"1","tot":"str"},{"t":"set","p":"interval_unit","pt":"msg","to":"seconds","tot":"str"},{"t":"set","p":"interval_activeInstantly","pt":"msg","to":"false","tot":"bool"},{"t":"set","p":"interval_fireInstantly","pt":"msg","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":370,"y":320,"wires":[["eac9bf6d.10099"]]},{"id":"f82b405a.ae475","type":"inject","z":"86722306.5dedf","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":340,"wires":[["880ea897.cc9578"]]},{"id":"89d2abf4.652378","type":"inject","z":"86722306.5dedf","name":"stahp","topic":"","payload":"disabled","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":580,"wires":[["eac9bf6d.10099"]]},{"id":"a1bc99a0.e8d908","type":"inject","z":"86722306.5dedf","name":"power","topic":"","payload":"enabled","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":640,"wires":[["eac9bf6d.10099"]]},{"id":"f5b617bb.baadc8","type":"change","z":"86722306.5dedf","name":"override_1.2s_insta","rules":[{"t":"set","p":"payload","pt":"msg","to":"interval","tot":"str"},{"t":"set","p":"interval_value","pt":"msg","to":"1150","tot":"str"},{"t":"set","p":"interval_unit","pt":"msg","to":"ms","tot":"str"},{"t":"set","p":"interval_activeInstantly","pt":"msg","to":"true","tot":"bool"},{"t":"set","p":"interval_fireInstantly","pt":"msg","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":440,"wires":[["eac9bf6d.10099"]]},{"id":"cee4d536.0dfd48","type":"inject","z":"86722306.5dedf","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":500,"wires":[["f5b617bb.baadc8"]]},{"id":"5ad007e.fa11cf8","type":"change","z":"86722306.5dedf","name":"FIRE_set_3s","rules":[{"t":"set","p":"payload","pt":"msg","to":"interval","tot":"str"},{"t":"set","p":"interval_value","pt":"msg","to":"3","tot":"str"},{"t":"set","p":"interval_unit","pt":"msg","to":"s","tot":"str"},{"t":"set","p":"interval_activeInstantly","pt":"msg","to":"true","tot":"bool"},{"t":"set","p":"interval_fireInstantly","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":390,"y":680,"wires":[["eac9bf6d.10099"]]},{"id":"379d05fa.71cd1a","type":"inject","z":"86722306.5dedf","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":720,"wires":[["5ad007e.fa11cf8"]]},{"id":"3a8bb62c.b1402a","type":"change","z":"937423a3.0cf86","name":"","rules":[{"t":"set","p":"interval_value","pt":"msg","to":"set_value","tot":"global"}],"action":"","property":"","from":"","to":"","reg":false,"x":360,"y":740,"wires":[[]]},{"id":"eac9bf6d.10099","type":"configurable interval","z":"86722306.5dedf","name":"configurable interval","interval":10,"onstart":false,"do_enable":true,"msg":"ping","showstatus":true,"unit":"seconds","statusformat":"YYYY-MM-D HH:mm:ss","x":660,"y":300,"wires":[[]]},{"id":"fe61c252.0e6e8","type":"rpi-dht22","z":"f6c2454e.b1ec78","name":"","topic":"rpi-dht22","dht":22,"pintype":"0","pin":4,"x":1360,"y":420,"wires":[["855f1741.abfe58","cd01889f.520c98","b0cfd3f1.72009","46a3005b.e24ce"]]},{"id":"855f1741.abfe58","type":"function","z":"f6c2454e.b1ec78","name":"온도-추출-전달","func":"\nvar test={};\n\ntest.topic=\"온도\";\ntest.payload=msg.payload;\n\nreturn test;","outputs":1,"noerr":0,"x":1560,"y":480,"wires":[[]]},{"id":"cd01889f.520c98","type":"function","z":"f6c2454e.b1ec78","name":"습도-추출-전달","func":"\nvar test={};\n\ntest.topic=\"습도\";\ntest.payload=msg.humidity;\n\nreturn test;","outputs":1,"noerr":0,"x":1560,"y":540,"wires":[[]]},{"id":"b0cfd3f1.72009","type":"function","z":"f6c2454e.b1ec78","name":"습도경고","func":"if(msg.humidity > 50){\n\nvar test={};\n\ntest.payload=\"습도 경고!\"\n\nreturn test;\n}else{\n   return null;\n}\n","outputs":1,"noerr":0,"x":1520,"y":660,"wires":[["a6fc99b6.befb88"]]},{"id":"a6fc99b6.befb88","type":"debug","z":"f6c2454e.b1ec78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1690,"y":660,"wires":[]},{"id":"cdcbdbb8.2369a8","type":"comment","z":"f6c2454e.b1ec78","name":"MQTT 분기용 Function","info":"","x":1560,"y":620,"wires":[]},{"id":"46a3005b.e24ce","type":"mqtt out","z":"f6c2454e.b1ec78","name":"","topic":"/hello","qos":"","retain":"","broker":"2bcc64f3.be443c","x":1650,"y":300,"wires":[]},{"id":"27fc8f0e.dcd5b","type":"pythonshell in","z":"f6c2454e.b1ec78","name":"","pyfile":"/home/pi/dev-py/PMS7003-master/PMS7003-master/dust_chk.py","virtualenv":"","continuous":false,"stdInData":false,"x":1400,"y":740,"wires":[["ea850e09.ee577"]]},{"id":"ea850e09.ee577","type":"function","z":"f6c2454e.b1ec78","name":"미세-추출-전달","func":"var test={}\nvar temp=msg.payload.split(\"\\n\");\n\ntest.pm25={'payload':temp[3]};\ntest.pm10={'payload':temp[5]};\n\nreturn [test.pm25, test.pm10];","outputs":2,"noerr":0,"x":1620,"y":740,"wires":[[],[]]},{"id":"9a5d243a.696578","type":"configurable interval","z":"f6c2454e.b1ec78","name":"time-controller[DHT]","interval":"1","onstart":false,"do_enable":false,"msg":"dht_test_ping","showstatus":true,"unit":"seconds","statusformat":"YYYY-MM-D HH:mm:ss","x":1140,"y":440,"wires":[["52e5c75c.2d5e58"]]},{"id":"d038414a.7cfa1","type":"configurable interval","z":"f6c2454e.b1ec78","name":"time-controller[PMS]","interval":"1","onstart":false,"do_enable":false,"msg":"ping","showstatus":true,"unit":"seconds","statusformat":"YYYY-MM-D HH:mm:ss","x":1120,"y":700,"wires":[[]]},{"id":"66701e2a.7cf3c","type":"mqtt in","z":"f6c2454e.b1ec78","name":"","topic":"/rasp-set-config","qos":"2","datatype":"auto","broker":"2bcc64f3.be443c","x":160,"y":160,"wires":[["b7f57668.474198","5dde0fc9.734e1"]]},{"id":"b7f57668.474198","type":"debug","z":"f6c2454e.b1ec78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":350,"y":80,"wires":[]},{"id":"f562ec49.da76e","type":"comment","z":"f6c2454e.b1ec78","name":"PUB-명령어","info":"mosquitto_pub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /rasp-set-config -m \"???\"\nmosquitto_pub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /rasp-set-config -m \"{\\\"result\\\":true, \\\"count\\\":1}\"\nmosquitto_pub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /111 -m \"{\\\"result\\\":true, \\\"count\\\":1}\"\n\n//인증테스트\nmosquitto_pub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /rasp-set-config -m \"{\\\"protocol\\\":\\\"server_certification\\\", \\\"REQ_MAC\\\":\\\"b8:27:eb:e8:7d:0f\\\"}\"\n\nprotocol == \"server_certification\"\n\n//sensor_config\nmosquitto_pub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /rasp-set-config -m \"{\\\"protocol\\\":\\\"sensor_config\\\", \\\"target\\\":\\\"dht\\\", \\\"interval_value\\\":1,\\\"power\\\":\\\"enabled\\\"}\"\nmosquitto_pub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /rasp-set-config -m \"{\\\"protocol\\\":\\\"sensor_config\\\", \\\"target\\\":\\\"dht\\\", \\\"interval_value\\\":1,\\\"power\\\":\\\"disabled\\\"}\"\n\n\n\nmosquitto_sub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t / -m \"{\\\"result\\\":true, \\\"count\\\":1}\"\n\nvar json = '{\"result\":true, \"count\":42}';\nobj = JSON.parse(json);\n\nconsole.log(obj.count);\n// expected output: 42\n\nconsole.log(obj.result);\n// expected output: true\n","x":150,"y":220,"wires":[]},{"id":"4ae43066.9e6b","type":"comment","z":"f6c2454e.b1ec78","name":"JSON-PARSE","info":"var json = '{\"result\":true, \"count\":42}';\nobj = JSON.parse(json);\n\nmsg={}\nmsg.payload=obj.result;\n\nreturn msg;","x":150,"y":440,"wires":[]},{"id":"df70195.b4345e8","type":"config","z":"f6c2454e.b1ec78","name":"ON","properties":[{"p":"test1","pt":"global","to":"{\"test\":100}","tot":"json"},{"p":"power","pt":"global","to":"true","tot":"bool"},{"p":"set_value","pt":"global","to":"5","tot":"num"}],"active":true,"x":670,"y":120,"wires":[]},{"id":"5dde0fc9.734e1","type":"function","z":"f6c2454e.b1ec78","name":"파싱-컨트롤러","func":"var json = JSON.parse(msg.payload);\n\nmsg={}\n\nif(json.result == true){\nmsg.v2=json.result;\n}\n\nif(json.protocol == \"sensor_config\"){\nmsg.v3=json;\n}\n\nif(json.protocol == \"server_certification\"){\nmsg.v4=json;\n}\n\n\nreturn [msg.v1, msg.v2, msg.v3, msg.v4];","outputs":4,"noerr":0,"x":380,"y":300,"wires":[["a131ef38.b38a5"],["df70195.b4345e8"],["f9fcfdac.eb33","c4dbb9ca.5095a8"],["1f2cb907.b93447","b4892b07.60d768"]]},{"id":"a131ef38.b38a5","type":"config","z":"f6c2454e.b1ec78","name":"OFF","properties":[{"p":"test1","pt":"global","to":"{\"test\":200}","tot":"json"},{"p":"power","pt":"global","to":"false","tot":"bool"},{"p":"test_time","pt":"global","to":"","tot":"date"},{"p":"set_value","pt":"global","to":"15","tot":"num"},{"p":"server_certification","pt":"global","to":"false","tot":"bool"}],"active":true,"x":670,"y":60,"wires":[]},{"id":"3ed03bd5.a1bdc4","type":"comment","z":"f6c2454e.b1ec78","name":"TO-DO","info":"1. 시스템이 켜지면 처음에는 모든 센서가 꺼져 있어야한다.\n2. 메세지 기반으로 데이터 값 처리","x":130,"y":480,"wires":[]},{"id":"f9fcfdac.eb33","type":"function","z":"f6c2454e.b1ec78","name":"센서-컨트롤러","func":"var v1 = {};\nvar v2 = {};\nvar v3 = {};\nvar v4 = {};\n    \nif(global.get(\"server_certification\") == false){\n    v2.payload=\"disabled\";\n    v4.payload=\"disabled\";\n\n    return [null, v2, null, v4];\n}\n\nif(msg.target == \"dht\" && global.get(\"server_certification\") == true){\nv1.interval_value=msg.interval_value;\nv2.payload=msg.power;\n\nreturn [v1, v2, null, null];\n}\n\nif(msg.target == \"pms\" && global.get(\"server_certification\") == true){\nv3.interval_value=msg.interval_value;\nv4.payload=msg.power;\nreturn [null, null, v3, v4];\n}\n\n//return [v1, v2, v3, v4];","outputs":4,"noerr":0,"x":560,"y":560,"wires":[["169365d7.11dd8a"],["4e4a25f7.c471dc"],["16ffb2f0.a8d08d","ad14b2be.0a125"],["647d176.03303e8","ad14b2be.0a125"]]},{"id":"1f2cb907.b93447","type":"function","z":"f6c2454e.b1ec78","name":"인증-받기","func":"if(msg.REQ_MAC == global.get(\"MAC_wlan0\")){\n    global.set(\"server_certification\",true);\n}","outputs":1,"noerr":0,"x":660,"y":320,"wires":[[]]},{"id":"62be2422.6f059c","type":"function","z":"f6c2454e.b1ec78","name":"인증-시도","func":"var wlan=global.get(\"MAC_wlan0\");\n\nmsg.payload={\"MAC_wlan0\": wlan};\n\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":140,"wires":[["c463861d.341fa8"]]},{"id":"21b22383.9cfd4c","type":"comment","z":"f6c2454e.b1ec78","name":"센서 JSON 안내","info":"\nJASON\n{\n    \"protocol\": \n                //list\n                \"server_certification\"\n                \"sensor_config\",\n\n    \"target\" : \n                \"dht\"\n                \"pms\",\n                \n    \"interval_value\": 숫자,\n    \n    \"power\":\n                \"enabled\"\n                \"disabled\"\n    \n}","x":540,"y":620,"wires":[]},{"id":"74d8c499.0fe43c","type":"debug","z":"ea60bfd7.dee7","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":990,"y":140,"wires":[]},{"id":"1becd816.672668","type":"function","z":"ea60bfd7.dee7","name":"wlan0 추출/선언","func":"var ifconfig={};\nifconfig.payload= msg.payload.split(\"\\n\")[0];\n\nglobal.set(\"MAC_wlan0\",ifconfig.payload);\n\nreturn ifconfig;","outputs":1,"noerr":0,"x":750,"y":140,"wires":[[]]},{"id":"ca33a34a.44dd1","type":"exec","z":"ea60bfd7.dee7","command":"cat /sys/class/net/wlan0/address","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":440,"y":140,"wires":[["1becd816.672668"],[],[]]},{"id":"895bc6b1.804e98","type":"inject","z":"ea60bfd7.dee7","name":"구동시 - 실행","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":180,"y":180,"wires":[["ca33a34a.44dd1","fdf414ab.548cc8"]]},{"id":"fdf414ab.548cc8","type":"exec","z":"ea60bfd7.dee7","command":"ls /sys/class/net/","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":390,"y":220,"wires":[["84360918.ccc848"],[],[]]},{"id":"84360918.ccc848","type":"function","z":"ea60bfd7.dee7","name":"파싱","func":"var temp= msg.payload.split(\"\\n\");\nifconfig={};\nifconfig.payload=temp[0];\n\nvar test = {};\n\ntest.payload=\"cat /sys/class/net/\"+temp[0]+\"/address\";\n\nreturn [test, ifconfig];","outputs":2,"noerr":0,"x":590,"y":220,"wires":[["c03b8964.0f80a8"],["ecd077d5.6e74c8"]]},{"id":"3313d63.5f03a2a","type":"function","z":"ea60bfd7.dee7","name":"유선랜MAC 주소등록","func":"global.set(\"MAC_\"+global.get(\"MAC_NAME\"),msg.payload);\n","outputs":1,"noerr":0,"x":1070,"y":260,"wires":[[]]},{"id":"ecd077d5.6e74c8","type":"change","z":"ea60bfd7.dee7","name":"유선랜_MAC이름등록","rules":[{"t":"set","p":"MAC_NAME","pt":"global","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":740,"y":340,"wires":[[]]},{"id":"25712571.b99c6a","type":"debug","z":"ea60bfd7.dee7","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1010,"y":360,"wires":[]},{"id":"c463861d.341fa8","type":"mqtt out","z":"f6c2454e.b1ec78","name":"","topic":"/gateway_certification","qos":"","retain":"","broker":"2bcc64f3.be443c","x":1260,"y":140,"wires":[]},{"id":"3aed13ca.7480dc","type":"inject","z":"f6c2454e.b1ec78","name":"인증 테스트 버튼","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":880,"y":140,"wires":[["62be2422.6f059c"]]},{"id":"1cd8e435.599b3c","type":"comment","z":"f6c2454e.b1ec78","name":"SUB-명령어","info":"mosquitto_pub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /rasp-set-config -m \"???\"\nmosquitto_pub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /rasp-set-config -m \"{\\\"result\\\":true, \\\"count\\\":1}\"\nmosquitto_pub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /111 -m \"{\\\"result\\\":true, \\\"count\\\":1}\"\n\nmosquitto_sub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /server_certification\nmosquitto_sub -h 121.160.17.68 -p 8883 --cafile D:\\dev\\openssl\\mqtt-ssl/server.crt -t /gateway_certification\nvar json = '{\"result\":true, \"count\":42}';\nobj = JSON.parse(json);\n\nconsole.log(obj.count);\n// expected output: 42\n\nconsole.log(obj.result);\n// expected output: true\n","x":1090,"y":180,"wires":[]},{"id":"b4892b07.60d768","type":"debug","z":"f6c2454e.b1ec78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":280,"wires":[]},{"id":"ed2fdfcb.e9f19","type":"comment","z":"f6c2454e.b1ec78","name":"PROTOCOL-LIST","info":"\n\"protocol\":\n\n            //LIST\n            \"server_certification\"\n            \"sensor_config\"\n","x":390,"y":240,"wires":[]},{"id":"169365d7.11dd8a","type":"change","z":"f6c2454e.b1ec78","name":"interval_setting","rules":[{"t":"set","p":"payload","pt":"msg","to":"interval","tot":"str"},{"t":"set","p":"interval_value","pt":"msg","to":"interval_value","tot":"msg"},{"t":"set","p":"interval_unit","pt":"msg","to":"seconds","tot":"str"},{"t":"set","p":"interval_activeInstantly","pt":"msg","to":"false","tot":"bool"},{"t":"set","p":"interval_fireInstantly","pt":"msg","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":880,"y":420,"wires":[["9a5d243a.696578"]]},{"id":"4e4a25f7.c471dc","type":"change","z":"f6c2454e.b1ec78","name":"power","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":480,"wires":[["9a5d243a.696578"]]},{"id":"647d176.03303e8","type":"change","z":"f6c2454e.b1ec78","name":"power","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":720,"wires":[["d038414a.7cfa1"]]},{"id":"52e5c75c.2d5e58","type":"debug","z":"f6c2454e.b1ec78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1310,"y":560,"wires":[]},{"id":"c4dbb9ca.5095a8","type":"debug","z":"f6c2454e.b1ec78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":590,"y":500,"wires":[]},{"id":"16ffb2f0.a8d08d","type":"change","z":"f6c2454e.b1ec78","name":"interval_setting","rules":[{"t":"set","p":"payload","pt":"msg","to":"interval","tot":"str"},{"t":"set","p":"interval_value","pt":"msg","to":"interval_value","tot":"msg"},{"t":"set","p":"interval_unit","pt":"msg","to":"seconds","tot":"str"},{"t":"set","p":"interval_activeInstantly","pt":"msg","to":"false","tot":"bool"},{"t":"set","p":"interval_fireInstantly","pt":"msg","to":"false","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":880,"y":660,"wires":[["d038414a.7cfa1"]]},{"id":"ad14b2be.0a125","type":"debug","z":"f6c2454e.b1ec78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":580,"wires":[]},{"id":"c03b8964.0f80a8","type":"exec","z":"ea60bfd7.dee7","command":"","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":810,"y":240,"wires":[["3313d63.5f03a2a"],[],[]]}]
```
